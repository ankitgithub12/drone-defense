<!DOCTYPE html>
<html>
<head>
    <title>Village Drone Shield</title>
    <link rel="stylesheet" href="/static/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="data:,"> <!-- Disable favicon requests -->
</head>
<body>
    <!-- Your existing HTML structure remains the same -->
    <div class="radar-container">[...]</div>

    <audio id="alarmSound" src="/static/alarm.mp3" preload="auto"></audio>
    <audio id="sirenSound" src="/static/siren.mp3" preload="auto"></audio>

    <script>
        // Audio elements
        const alarmSound = document.getElementById('alarmSound');
        const sirenSound = document.getElementById('sirenSound');
        
        // Unlock audio on first interaction
        const unlockAudio = () => {
            alarmSound.play().then(() => alarmSound.pause()).catch(e => console.log("Audio unlocked"));
            document.removeEventListener('click', unlockAudio);
        };
        document.addEventListener('click', unlockAudio);

        // DOM elements
        const alertBox = document.getElementById('alertBox');
        const droneBlip = document.getElementById('droneBlip');
        const distanceText = document.getElementById('distanceText');
        const emergencyBtn = document.getElementById('emergencyBtn');
        const bars = [
            document.getElementById('bar1'),
            document.getElementById('bar2'), 
            document.getElementById('bar3')
        ];

        // Optimized status checking
        let lastUpdate = 0;
        const UPDATE_INTERVAL = 5000; // 5 seconds

        function updateUI(data) {
            if (data.detected) {
                alertBox.classList.remove('hidden');
                distanceText.textContent = `${data.distance}m away`;
                
                const angle = Math.atan2(
                    data.location[1] - 77.2090, 
                    data.location[0] - 28.6139
                );
                const distance = Math.min(90, data.distance / 5);
                droneBlip.style.left = `${50 + distance * Math.cos(angle)}%`;
                droneBlip.style.top = `${50 + distance * Math.sin(angle)}%`;
                droneBlip.classList.remove('hidden');

                alarmSound.currentTime = 0;
                alarmSound.play().catch(e => console.log("Playback error:", e));

                data.nodes.forEach((node, i) => {
                    const strength = Math.max(0, Math.min(100, (node.last_rssi + 90) * 3.33));
                    bars[i].style.width = `${strength}%`;
                    bars[i].style.backgroundColor = 
                        strength > 70 ? '#2ecc71' : 
                        strength > 30 ? '#f39c12' : '#e74c3c';
                });
            } else {
                alertBox.classList.add('hidden');
                droneBlip.classList.add('hidden');
            }
        }

        // Optimized status checker
        function checkStatus() {
            const now = Date.now();
            if (now - lastUpdate < UPDATE_INTERVAL) return;
            
            lastUpdate = now;
            fetch('/status')
                .then(res => res.ok ? res.json() : Promise.reject())
                .then(updateUI)
                .catch(e => console.log("Status check skipped:", e));
        }

        // Animation frame-based loop
        function animationLoop() {
            checkStatus();
            requestAnimationFrame(animationLoop);
        }
        animationLoop();

        // Emergency button
        emergencyBtn.addEventListener('click', () => {
            sirenSound.currentTime = 0;
            sirenSound.play();
            fetch('/emergency', { 
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            }).catch(e => console.log("Emergency signal error:", e));
        });
    </script>
</body>
</html>